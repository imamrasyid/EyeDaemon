name: Markdown Lint

on:
  # Run on push to main branch
  push:
    branches:
      - main
    paths:
      - "**.md"
      - ".github/workflows/markdown-lint.yml"
      - ".markdownlint.json"

  # Run on pull requests that modify markdown files
  pull_request:
    paths:
      - "**.md"

  # Allow manual trigger
  workflow_dispatch:

jobs:
  markdown-lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install markdownlint-cli
        run: npm install -g markdownlint-cli

      - name: Run markdownlint
        run: markdownlint '**/*.md' --ignore node_modules --ignore coverage --config .markdownlint.json
        continue-on-error: true
        id: lint

      - name: Generate lint report
        if: always()
        run: |
          echo "# Markdown Lint Report" > lint-report.md
          echo "" >> lint-report.md
          echo "**Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> lint-report.md
          echo "" >> lint-report.md

          if [ "${{ steps.lint.outcome }}" == "success" ]; then
            echo "✅ All markdown files passed linting!" >> lint-report.md
          else
            echo "⚠️ Some markdown files have linting issues." >> lint-report.md
            echo "" >> lint-report.md
            echo "Please review the workflow logs for details." >> lint-report.md
          fi

      - name: Upload lint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: markdown-lint-report
          path: lint-report.md

      - name: Comment on PR
        if: github.event_name == 'pull_request' && steps.lint.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ⚠️ Markdown Lint Issues Detected

            Some markdown files in this PR have linting issues.

            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Please review the workflow logs and fix the issues before merging.

            ### Common Issues
            - Missing blank lines around headings
            - Inconsistent list indentation
            - Trailing spaces
            - Missing alt text for images
            - Inconsistent heading styles

            ### How to Fix
            1. Check the workflow logs for specific issues
            2. Fix the markdown formatting
            3. Run \`markdownlint '**/*.md' --ignore node_modules\` locally to verify
            4. Push your changes

            ---
            *This comment was automatically created by the Markdown Lint workflow.*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Fail if linting failed
        if: steps.lint.outcome == 'failure'
        run: exit 1
